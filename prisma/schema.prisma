// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {

  provider = "mysql"
  url      = env("DATABASE_URL")
}



model Grade {
  id       Int             @id @default(autoincrement())
  grade    Int             @unique
  sections GradeSection[]  // Relationship to GradeSection
  assignment Assignment[]
  announcement Announcement[]

  // ✅ Add inverse relation to Assignment
  
}

model Section {
  id       Int             @id @default(autoincrement())
  section  String          @unique
  grades   GradeSection[]  // Relationship to GradeSection
  assignment Assignment[]

  // ✅ Add inverse relation to Assignment
 
}

model GradeSection {
  id        Int      @id @default(autoincrement())
  grade     Grade    @relation(fields: [gradeId], references: [id])
  gradeId   Int
  capacity   Int?   
  section   Section  @relation(fields: [sectionId], references: [id])
  sectionId Int
  status    GradeSectionEnum

  @@unique([gradeId, sectionId])
}

enum GradeSectionEnum {
  active
  inactive
}
model Semester {
  id            Int             @id @default(autoincrement())
  name          Int             @unique
  status        SemesterEnum

  resultDetails   ResultDetail[]   @relation("DetailSemester")
  resultSummaries ResultSummary[] @relation("SummarySemester")
}




model Year {
  id          Int      @id @default(autoincrement())
  year        Int      @unique
  status      YearEnum
}

model Subject {
  id   Int    @id @default(autoincrement())
  name String @unique
  assignment Assignment[]
}

model Announcement {
  id       Int             @id @default(autoincrement())
  title      String
  message    String
  createdAt  DateTime @default(now())
  audience   Audience
  gradeId     Int?      // optional for grade-specific
  staffID     Int
  grade      Grade?       @relation(fields: [gradeId], references: [grade])
  staff      Staff @relation(fields: [staffID], references: [staffID])
}

enum Audience {
  ALL         // everyone
  STAFF       // only staff
  STUDENTS    // only students
  PARENTS     // only parents
  GRADE       // for specific grade
}



model Staff {
  id              Int      @id @default(autoincrement())
  staffID         Int      @unique
  firstName       String
  middleName      String  // Optional, if not provided
  lastName        String
  phoneNumber     String
  username        String   @unique
  email           String   
  password        String
  image           String  // Optional field to store image filename
  role            RoleEnum? @default(staff)
  status          statusEnum @default(inactive)
  createdAt       DateTime @default(now())
  assignment      Assignment []
  attendances     Attendance[]  
  Staff_Attended  StaffAttendance[] @relation("FK_StaffAttendance_Staff")   
  Staff_Recorded StaffAttendance[] @relation("FK_StaffAttendance_Recorder") 
  resultDetail    ResultDetail[]
  exam            Exam []
  announcement   Announcement[]
  bookBorrow      BookBorrow[]
  disciplineRecord DisciplineRecord[]
}


model Assignment {
  id         Int      @id @default(autoincrement())
  staffID    Int
  gradeId    Int
  sectionId  Int
  subjectId  Int

  // Relationships
  staff      Staff    @relation(fields: [staffID], references: [staffID])
  grade      Grade    @relation(fields: [gradeId], references: [id])
  section    Section  @relation(fields: [sectionId], references: [id])
  subject    Subject  @relation(fields: [subjectId], references: [id])

  @@index([staffID, gradeId, sectionId]) // Index for faster querying
  @@unique([staffID, gradeId, sectionId]) // Ensure a staff member is assigned to a grade and section only once
  
  
 
}


model Parent {
  id               Int      @id @default(autoincrement())  // Parent unique ID
  firstName        String   // Parent first name
  lastName         String   // Parent last name
  email            String   @unique // Parent email for login
  password         String   // Encrypted password
  phoneNumber      String?  // Optional phone number
  address          String?  // Optional address
  createdAt        DateTime @default(now()) // Account creation date

// One parent can have multiple students
  children         Student[] // Relationship with the students
}

model Student {
  id               Int     @id @default(autoincrement())
  studentID        String    @unique // ✅ Ensure studentID is unique for foreign key reference
  firstName        String
  middleName       String
  lastName         String
  age              Int
  gender           genderEnum
  phoneNumber      String
  email            String
  password         String
  parentID         Int?    // Foreign key linking to the Parent table
  image            String?
  status           enumSStatus @default(active)
  createdAt        DateTime @default(now())
  parent           Parent?  @relation(fields: [parentID], references: [id]) 
  registrations    Registration[] 
  attendance       Attendance[]
  response         Response[]
  studentSession   StudentSession[]
  bookBorrow       BookBorrow[]
  fee              Fee[]
  disciplineRecord  DisciplineRecord[]
}


model Registration {
  registrationID    Int      @id @default(autoincrement())
  studentID         String
  stream            enumStream @default(SCIENCE)
  year              Int
  grade             Int
  section           String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  student           Student  @relation(fields: [studentID], references: [studentID])
  resultDetail      ResultDetail[]
  resultSummary     ResultSummary[]
}


model ResultDetail {
  id             Int          @id @default(autoincrement())
  registrationID Int
  staffID        Int
  semester       Int          // references Semester.name
  subject        String
  score          Int?

  registration   Registration @relation(fields: [registrationID], references: [registrationID])
  staff          Staff        @relation(fields: [staffID], references: [staffID])
  semesterRef    Semester     @relation("DetailSemester", fields: [semester], references: [name])

  @@unique([registrationID, subject, semester], name: "registrationID_subject_semester")
}

model ResultSummary {
  id             Int          @id @default(autoincrement())
  registrationID Int
  semester       Int          // references Semester.name
  average        Float
  passStatus     passEnum
  rank           Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  registration   Registration @relation(fields: [registrationID], references: [registrationID])
  semesterRef    Semester     @relation("SummarySemester", fields: [semester], references: [name])

  @@unique([registrationID, semester])
}


enum passEnum {
  passed
  failed
  incomplete
}


model Attendance {
  id              Int      @id @default(autoincrement())
  date            DateTime @default(now()) // Date of attendance
  status          attendanceStatus 
  studentID       String      // Foreign key to Student
  staffID         Int      // Foreign key to Staff
  student         Student  @relation(fields: [studentID], references: [studentID])
  staff     Staff @relation(fields: [staffID], references: [staffID])

  

}
model StaffAttendance {
  id        Int      @id @default(autoincrement())
  date      DateTime @default(now()) // Date of attendance
  status    staffEnum

  staffID   Int  // Foreign key to Staff (attended staff)
  userID    Int  // Foreign key to the user who recorded the attendance

  
 recordedBy Staff @relation(fields: [userID], references: [staffID], name: "FK_StaffAttendance_Recorder")
 staff     Staff @relation(fields: [staffID], references: [staffID], name: "FK_StaffAttendance_Staff")

}



model Exam {
  id          Int       @id @default(autoincrement())
  title       String    @unique
  description String?
  startTime   DateTime
  endTime     DateTime
  createdBy   Int       // Staff who created the exam
  staff       Staff     @relation(fields: [createdBy], references: [staffID])
  questions   Question[]
  responses   Response[]
}

model Question {
  id        Int      @id @default(autoincrement())
  examId    Int
  content   String   // Question text
  optionA      String
  optionB      String
  optionC      String
  optionD      String
  correct   String   // Correct option (e.g., "A")
  exam      Exam     @relation(fields: [examId], references: [id])
  response Response[]
}

model Response {
  id          Int       @id @default(autoincrement())
  examId      Int
  studentID   String
  questionId  Int
  answer      String?   // Student's chosen option
  submittedAt DateTime? // Auto-submit if time runs out
  student     Student   @relation(fields: [studentID], references: [studentID])
  exam        Exam      @relation(fields: [examId], references: [id])
  question    Question  @relation(fields: [questionId], references: [id])
  @@unique([studentID, questionId, examId])  // ✅ Ensure this unique constraint exists
}


model StudentSession {
  studentID        String    @id @unique
  deviceFingerprint String
  student          Student @relation(fields: [studentID], references: [studentID])
}

model Book {
  id        Int       @id @default(autoincrement())
  title     String
  author    String
  grade     String    // e.g., "Grade 5", "General"
  copies    Int       // Number of total copies
  borrows   BookBorrow[]
  createdAt DateTime  @default(now())
}

model BookBorrow {
  id         Int      @id @default(autoincrement())
  studentID  String
  bookId     Int
  borrowDate DateTime @default(now())
  returnDate DateTime?
  staffID    Int
  staff      Staff @relation(fields: [staffID], references: [staffID])

  book       Book     @relation(fields: [bookId], references: [id])
  student     Student    @relation(fields: [studentID], references: [studentID])
  fine        Fine[]
}

model Fine {
  id          Int       @id @default(autoincrement())
  borrowRecordId Int    @unique
  amount      Float
  issuedAt    DateTime  @default(now())
  paid        Boolean   @default(false)

  borrowRecord BookBorrow @relation(fields: [borrowRecordId], references: [id])
}

model Fee {
  id           Int             @id @default(autoincrement())
  studentID    String
  grade        Int
  email        String?
  month        MonthEnum
  status       FeeStatusEnum   @default(unpaid)
  amountPaid   Float?
  year         Int             @default(2025)
  paymentDate  DateTime        @default(now())
  student      Student         @relation(fields: [studentID], references: [studentID])

  @@unique([studentID, month, year])
}


model DisciplineRecord {
  id         Int      @id @default(autoincrement())
  studentID  String
  staffID    Int
  message    String
  createdAt  DateTime @default(now())

  student    Student  @relation(fields: [studentID], references: [studentID])
  staff      Staff    @relation(fields: [staffID], references: [staffID])
}

model Message {
  id        Int      @id @default(autoincrement())
  name      String
  email     String
  message   String
  createdAt DateTime @default(now())
}


enum MonthEnum {
  January
  February
  March
  April
  May
  June
  July
  August
  September
  October
  November
  December
}

enum FeeStatusEnum {
  paid
  unpaid
  pending
}






enum   staffEnum{
  present
  absent
  late
}

enum  attendanceStatus{
  present
  absent
  late
}




enum enumSStatus{
  active
  inactive
  block
}
enum enumStream{
  SCIENCE
  NATURAL
  SOCIAL
}
enum passStatusEnum{
  passed
  failed
  incomplete

}

enum RoleEnum{
  head
  admin
  registrar
  staff
  teacher
  library
}
enum statusEnum{
  active
  inactive
  block
}

enum  SemesterEnum{
  active
  inactive
}

enum YearEnum {
  active
  inactive
}

enum genderEnum{
  MALE
  FEMALE
}